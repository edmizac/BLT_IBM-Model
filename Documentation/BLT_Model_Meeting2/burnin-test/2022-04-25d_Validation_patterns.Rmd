---
title: "BLT Meeting output (Validation) burnin run v1"
author: "Eduardo Zanette"
date: "25/04/2022"
abstract: |

  This document was produced for the purpose of presentation to Laurence and Ronald on 25/04/2022, the second BLT Model Meeting while in Germany. For documentation reasons, this run was made with the version v1 of the model. Here, we analyze the Memory and Foraging aspects of the model. 
  The memory component is assessed through a comparison of empirical data with one run (n = 30 days), but we also differentiate between the whole run (30 days) and the 20 last days, because the step_forget paramater (= working memory) seemed to make the tamarin move more after a "burn-in period" of 10 days.
  The results show that the burn-in period does not seem to make a difference in the v1 version of the model, but this should be throughly tested. Regarding foraging behavior, tamarins spend too much time foraging in a row.
  
  Obs: for easier visualization/discussion, check xlsx presentation "Presentation-for.Laurence.xlsx"
      
output: 
  pdf_document:
  
fontsize: 12pt
toc: yes
toc_depth: 3
number_sections: yes
# baselinestretch: 1.12
# linestretch: 1.22
# toc: yes
# toc_depth: 3
# lof: True
# lot: True
# papersize: a4
# tables: true
# number_sections: yes
---

\pagenumbering{arabic}

> Conclusions

#### The *four* problems with this model are:

1) Regarding DPL and Turning angles, it is the same before and after the burn-in period, but revisitations and routes seem more "natural". Therefore, working memory (step_forget) still has to be throughly tested. 
2) Tamarins spend too much time foraging
2) Tamarins are still not properly bouncing at the border of the fragment (while foraging)
3) Foraging occurs for too long
4) Constant step lenght (velocity)

\pagebreak

```{r setup, include=FALSE}
# Packages
library(knitr)
library(rmarkdown)
library(flextable) ## having nice tables working also in LibreOffice
library(officer)
library(here)
library(ggplot2)
library(ggspatial)
library(dplyr)
library(sp)
library(adehabitatHR)
library(circular)

knitr::opts_chunk$set(echo = TRUE)

# GIS
our_crs <- "+proj=utm +zone=22 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
gua_xlim_all = c(780000, 782350)
gua_ylim_all = c(7407080, 7408250)
gua.x.min = 781587
gua.x.max = 782361.5
gua_xlim_set = c(781200, 782350)
gua_ylim_set = c(7407250, 7408250) 
sma_xlim_set = c(364400, 366000)
sma_ylim_set = c(7540500, 7541700)
taq_xlim_set = c(370500, 373200)
taq_ylim_set = c(7498750, 7500550)
suz_xlim_set = c(705300, 706200)
suz_ylim_set = c(7480800, 7481600) # 7480990,

# Plots
theme_set(theme_bw())
simulated_shapes <- c(1, 19, 1, 17, 1)
simulated_colors <- c("magenta", "#1E8449", "grey", "#E74C3C", "grey")
simulated_colors_noforage <- c("grey", "#1E8449", "grey", "#E74C3C", "grey")

empirical_shapes <- c(1, 19, 1, 1, 1, 1, 1, 1, 1, 17, 1, 1)
empirical_colors <- c("magenta", "#1E8449", "grey", "grey", "grey", "grey", "grey", 
                                "grey", "grey", "#E74C3C", "grey", "grey")


# Knitr
knitr::opts_chunk$set(echo = TRUE,
                      fig.align='center')
```

```{r Load shapefiles, results="hide", warning=F, echo=F}
gua.polyg <- sf::st_read(here("Data", "shapefiles", "Fragment polygon.shp"))
```

```{r Base Guarei sf plot, include=FALSE}
gua.sf <- ggplot2::ggplot() +
  geom_sf(data = gua.polyg,
          color = "black",
          fill = "#A9DFBF") +
  coord_sf(
    datum = sf::st_crs(our_crs),
    xlim = gua_xlim_set,    
    ylim = gua_ylim_set) +  
  theme_bw() +
  annotation_scale(location = "bl", width_hint = .35) +
  annotation_north_arrow(location = "bl", which_north = "true",
                         pad_x = unit(0, "cm"), pad_y = unit(.8, "cm"),
                         style = north_arrow_fancy_orienteering)
```

### Guareí empirical (all data, 28 days) and July (6 days)
```{r, echo=F, warnings = F, message=F}
dat.gua.orig <- read.csv2("D:/Data/Documentos/github/BLT-Movement-Patterns/asltraj/ltraj_df_Data_Guarei_Felipe_EMZ1.csv", dec = ".", stringsAsFactors = TRUE)
dat.gua.orig <- dat.gua.orig %>%
  rename(datetime = POSIXct) %>%
  mutate(datetime = lubridate::ymd_hms(datetime))

dat.gua.orig <- dat.gua.orig %>% 
  mutate(day = lubridate::day(datetime)) %>% 
  mutate(month = lubridate::month(datetime)) %>% 
  mutate(day_month = paste0(dat.gua.orig$day, "-", dat.gua.orig$month))

gua.plot <- gua.sf +
  geom_path(data = dat.gua.orig,
            aes(x = x, y = y, group = day_month), 
            size = 0.15) +
  geom_point(data = dat.gua.orig,
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior), 
             size = 2.7) +
  ggtitle("Empirical (all data, 28 days)") +
  scale_shape_manual(values = c(1, 19, 1, 1, 1, 1, 1, 1, 1, 17, 1, 1)) +
  scale_color_manual(values = c("grey", "#1E8449", "grey", "grey", "grey", "grey", "grey", "grey", "grey", "#E74C3C", "grey", "grey"))
  
gua.plot

dat.gua.orig.jul <- dat.gua.orig %>% filter(month == 6)

gua.plot <- gua.sf +
  geom_path(data = dat.gua.orig.jul,
            aes(x = x, y = y, group = day_month), 
            size = 0.15) +
  geom_point(data = dat.gua.orig.jul,
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior), 
             size = 2.7) +
  ggtitle("Empirical (July only, 6 days)") +
  scale_shape_manual(values = c(1, 19, 1, 1, 1, 1, 17, 1, 1)) +
  scale_color_manual(values = c("grey", "#1E8449", "magenta", "grey", "grey", "grey", "#E74C3C", "grey", "grey"))
  
gua.plot
```

\pagebreak

### Guareí simulated

```{r How a simulated plot should look like in general, include=FALSE}
loc_tam <- read.table(here("Documentation", "BLT_Model_Meeting2", "burnin-test", "locations_monkey.txt"), header = 1, stringsAsFactors = TRUE)

gua.plot.general <- gua.sf +
  geom_point(data = loc_tam,
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior)) +
  ggtitle("Guareí - simulated (30 days - Resources from July)")
gua.plot.general
```


```{r, echo=F}
loc_tam <- read.table(here("Documentation", "BLT_Model_Meeting2", "burnin-test",
                           "locations_monkey.txt"), header = 1, stringsAsFactors = TRUE)

gua.plot <- gua.sf +
  geom_path(data = loc_tam,
            aes(x = x, y = y, group = day), 
            size = 0.15) +
  geom_point(data = loc_tam,
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior)) +
  ggtitle("Simulated (30 days - Resources from July)") +
  scale_shape_manual(values = simulated_shapes) +
  scale_color_manual(values = simulated_colors_noforage)
  
gua.plot


gua.plot <- gua.sf +
  geom_path(data = loc_tam %>% filter(day <= 6),
            aes(x = x, y = y, group = day), 
            size = 0.15) +
  geom_point(data = loc_tam %>% filter(day <= 6),
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior)) +
  ggtitle("Simulated (first 6 days - Resources from July)") +
  scale_shape_manual(values = simulated_shapes) +
  scale_color_manual(values = simulated_colors_noforage)

gua.plot


gua.plot <- gua.sf +
  geom_path(data = loc_tam %>% filter(day > 10),
            aes(x = x, y = y, group = day), 
            size = 0.15) +
  geom_point(data = loc_tam %>% filter(day > 10),
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior)) +
  ggtitle("Simulated (20 days after burn in of 10 days - Resources from July)") +
  scale_shape_manual(values = simulated_shapes) +
  scale_color_manual(values = simulated_colors_noforage)
  
gua.plot


gua.plot <- gua.sf +
  geom_path(data = loc_tam %>% filter(day > 10 & day < 17),
            aes(x = x, y = y, group = day), 
            size = 0.15) +
  geom_point(data = loc_tam %>% filter(day > 10 & day < 17),
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior)) +
  ggtitle("Simulated (6 days after burn in of 10 days - Resources from July)") +
  scale_shape_manual(values = simulated_shapes) +
  scale_color_manual(values = simulated_colors_noforage)
  
gua.plot

```


***

\pagebreak

## Validation Patterns

We are not checking seed dispersal patterns now, just movement and ranging patterns.


### Dayly Path Lenght (DPL)

Calculate and plot DPL
```{r DPL function, echo = FALSE, }
dpl <- function(df) {
  dist_list <- numeric()
  dist <- numeric()
  for (df in split(df, df$day)) {
    dist <- 0
    for (i in 2:nrow(df)) {
      dist <- dist + sqrt((df$x[i] - df$x[i - 1]) ^ 2 +
                            (df$y[i] - df$y[i - 1]) ^ 2)
    }
    dist_list <- c(dist_list, dist)
  }
  return(dist_list)
}
```

```{r, echo=FALSE}
dpl_gua <- dpl(df = dat.gua.orig.jul)

avg_dist <- mean(dpl_gua)
sd_dist <- sd(dpl_gua)
# paste("Empirical (July, 6 days) Mean DPL (m)", round(avg_dist, 2))
# paste("Empirical (July, 6 days) DPL sd", round(sd_dist, 2))

dpl_sim <- dpl(df = loc_tam)

avg_dist_sim <- mean(dpl_sim)
sd_dist_sim <- sd(dpl_sim)
# paste("Simulated (July, 30 days) Mean DPL (m)", round(avg_dist_sim, 2))
# paste("Simulated (July, 30 days) DPL sd", round(sd_dist_sim, 2))

loc_tam_lastdays <- loc_tam %>% filter(day > 10) 
dpl_sim_lastdays <-loc_tam_lastdays %>% dpl()

avg_dist_sim_lastdays <- mean(dpl_sim_lastdays)
sd_dist_sim_lastdays <- sd(dpl_sim_lastdays)
# paste("Simulated (July, 20 days) Mean DPL (m) after burn-in run of 10 days", round(avg_dist_sim_lastdays, 2))
# paste("Simulated (July, 20 days) DPL sd after burn-in run of 10 days", round(sd_dist_sim_lastdays, 2))
```

```{r, include=FALSE}
hist_f <- function(x = x, main = main) {
  hist(x, xlab = "Daily Path Length (m)",
                           breaks=seq(500,4000,by=200),
                           ylim = c(0,10),
                           col = "grey",
                           main = main)
  }
```

```{r, echo=F}
par(xpd=TRUE)
par(oma=c(0,0,0,0))
par(mar=c(4,4,2,1))
par(mfrow=c(1,3))

hist <- hist_f(x=dpl_gua,
     main = "Empirical (July, 6 days)"
     )
abline(v=avg_dist, col="red", lty=2)
text(x=min(hist$breaks), y=max(hist$counts)
   , sprintf("sd = %7.2f", sd_dist)
   , adj = c(0, 0))
text(x=avg_dist, y=max(hist$counts)
   , sprintf("mean = %7.2f", avg_dist)
   , col = "red"
   , adj = c(-0.1, -0.3))

hist <- hist_f(x=dpl_sim,
             main="Simulated (July, 30 days)"
     )
abline(v=avg_dist_sim, col="red", lty=2)
text(x=min(hist$breaks), y=max(hist$counts)
   , sprintf("sd = %7.2f", sd_dist_sim)
   , adj = c(0, 0))
text(x=avg_dist_sim, y=max(hist$counts)
   , sprintf("mean = %7.2f", avg_dist_sim)
   , col = "red"
   , adj = c(-0.1, -0.3))


hist <- hist_f(x=dpl_sim_lastdays,
             main="Simulated (July, 20 days) after \nburn-in run of 10 days"
     )
abline(v=avg_dist_sim_lastdays, col="red", lty=2)
text(x=min(hist$breaks), y=max(hist$counts)
   , sprintf("sd = %7.2f", sd_dist_sim_lastdays)
   , adj = c(0, 0))
text(x=avg_dist_sim_lastdays, y=max(hist$counts)
   , sprintf("mean = %7.2f", avg_dist_sim_lastdays)
   , col = "red"
   , adj = c(-0.1, -0.3))

```

\pagebreak

### Home Range
Still to be done
Comparison between methods: https://doi.org/10.1111/2041-210X.13786

\pagebreak

### Turning Angles and Step Lenghts
```{r, include=FALSE}
dat.gua.orig.jul$id <- "Guareí Empirical"
dat.gua.orig.jul$id <- as.factor(dat.gua.orig.jul$id)
dat.gua.orig.jul$dayfct <- as.factor(paste("Day ", dat.gua.orig.jul$day))

dat.gua.orig.jul_ltraj <- adehabitatLT::as.ltraj(xy = dat.gua.orig.jul[, c("x", "y")], 
                                       id = dat.gua.orig.jul$id,
                                       burst = dat.gua.orig.jul$dayfct,
                                       proj4string = CRS(our_crs),
                                       typeII = FALSE,
                                       infolocs = dat.gua.orig.jul[ , c("behavior", "dayfct")]
                                       )
# Type I (time not recorded) -> OK. Infolocs -> OK
dat.gua.orig.jul_ltraj_df <- ld(dat.gua.orig.jul_ltraj) # Transform to df


loc_tam$id <-  "Guareí Simulated" 
loc_tam$id <- as.factor(loc_tam$id)
loc_tam$dayfct <- as.factor(paste("Day ", loc_tam$day))

loc_tam_ltraj <- adehabitatLT::as.ltraj(xy = loc_tam[, c("x", "y")], 
                                       id = loc_tam$id,
                                       burst = loc_tam$dayfct,
                                       proj4string = CRS(our_crs),
                                       typeII = FALSE,
                                       infolocs = loc_tam[ , c(1:3, 6, 8:10)]
                                       )
# Type I (time not recorded) -> OK. Infolocs -> OK
loc_tam_ltraj_df <- ld(loc_tam_ltraj) # Transform to df

loc_tam_lastdays$id <-  "Guareí Simulated after burn-in run" 
loc_tam_lastdays$id <- as.factor(loc_tam_lastdays$id)
loc_tam_lastdays$dayfct <- as.factor(paste("Day ", loc_tam_lastdays$day))

loc_tam_lastdays_ltraj <- adehabitatLT::as.ltraj(xy = loc_tam_lastdays[, c("x", "y")], 
                                       id = loc_tam_lastdays$id,
                                       burst = loc_tam_lastdays$dayfct,
                                       proj4string = CRS(our_crs),
                                       typeII = FALSE,
                                       infolocs = loc_tam_lastdays[ , c(1:3, 6, 8:10)]
                                       )
# Type I (time not recorded) -> OK. Infolocs -> OK
loc_tam_lastdays_ltraj_df <- ld(loc_tam_lastdays_ltraj) # Transform to df

```

```{r Mean step lenght and turning angles, warning=FALSE, echo=F}
# mean rel angle (degrees)
paste("Empirical (July, 6 d) Mean Relative Angle (degrees) = ", 
      dat.gua.orig.jul_ltraj_df$rel.angle %>%
        mean(na.rm = T) %>% round(2))

paste("Simulated (July, 30 d) Mean Relative Angle (degrees)", 
      loc_tam_ltraj_df$rel.angle %>%
        mean(na.rm = T )%>% round(2))
      
paste("Simulated (July, 20 d, after burn-in run of 10 days) Mean Relative Angle (degrees)", 
      loc_tam_lastdays_ltraj_df$rel.angle %>%
        mean(na.rm = T) %>% round(2))

# mean rel angle (radians)
dat.gua.orig.jul_ltraj_df$rel.angle.rad <- dat.gua.orig.jul_ltraj_df$rel.angle * (180 / pi)
loc_tam_ltraj_df$rel.angle.rad <- loc_tam_ltraj_df$rel.angle * (180 / pi)
loc_tam_lastdays_ltraj_df$rel.angle.rad <- loc_tam_lastdays_ltraj_df$rel.angle * (180 / pi)

dat.gua.orig.jul_ltraj_df_ra_mean <- dat.gua.orig.jul_ltraj_df$rel.angle.rad %>%  mean(na.rm = TRUE)
loc_tam_ltraj_df_ra_mean <- loc_tam_ltraj_df$rel.angle.rad %>% mean(na.rm = TRUE)
loc_tam_lastdays_ltraj_df_ra_mean <- loc_tam_lastdays_ltraj_df$rel.angle.rad %>% mean(na.rm = TRUE)

paste("Mean Relative Angle (degrees) :", dat.gua.orig.jul_ltraj_df_ra_mean)
paste("Mean Relative Angle (degrees) :", loc_tam_ltraj_df_ra_mean)
paste("Mean Relative Angle (degrees) :", loc_tam_lastdays_ltraj_df_ra_mean)


# mean step lenght
paste("Mean Step lenght (meters) :", dat.gua.orig.jul_ltraj_df$dist %>% mean(na.rm = T))
paste("Mean Step lenght (meters) :", loc_tam_ltraj_df$dist %>% mean(na.rm = T))
paste("Mean Step lenght (meters) :", loc_tam_lastdays_ltraj_df$dist %>% mean(na.rm = T))
```

```{r Plot Step lenght + turnig angles, echo=F, warning=FALSE}
# Plot Step lengh
par(mfrow=c(1,3))
graphics::hist(dat.gua.orig.jul_ltraj_df$dist, 
               # breaks=10, 
               xlim = c(0, 400), ylim = c(0, 1000),
               xlab = "Step length (m)", main = "\nEmpirical (July, 6 d)") %>%
  abline(v = mean(dat.gua.orig.jul_ltraj_df$dist, na.rm = TRUE), col = "red", lwd = 3)
  text(200, 400, paste("mean = ", round(mean(dat.gua.orig.jul_ltraj_df$dist, na.rm = TRUE), 2), 
                      " m"), cex = 1.4)
  
graphics::hist(loc_tam_ltraj_df$dist, 
               # breaks=10, 
               xlim = c(0, 400), ylim = c(0, 1000),
               xlab = "Step length (m)", main = "\nSimulated (July, 30 d)")  %>%
  abline(v = mean(loc_tam_ltraj_df$dist, na.rm = TRUE), col = "red", lwd = 3)
  text(200, 400, paste("mean = ", round(mean(loc_tam_ltraj_df$dist, na.rm = TRUE), 2), 
                      " m"), cex = 1.4)
  
graphics::hist(loc_tam_lastdays_ltraj_df$dist, 
               # breaks=10, 
               xlim = c(0, 400), ylim = c(0, 1000),
               xlab = "Step length (m)", main = "\nSimulated (July, 20 d, \nafter burn-in run of 10 days)")  %>%
  abline(v = mean(loc_tam_lastdays_ltraj_df$dist, na.rm = TRUE), col = "red", lwd = 3)
  text(200, 400, paste("mean = ", round(mean(loc_tam_lastdays_ltraj_df$dist, na.rm = TRUE), 2), 
                      " m"), cex = 1.4)


# Plot Turning angles
par(mfrow=c(1,3))

circular::rose.diag(dat.gua.orig.jul_ltraj_df$rel.angle, bins=30, prop=2.5, units = "degrees",
                    tol = 0, main = "\nEmpirical (July, 6 d)", cex = 1.2, shrink = 1.2, ticks = F)
circular::rose.diag(loc_tam_ltraj_df$rel.angle, bins=30, prop=2.5, units = "degrees", tol = 0,                      main = "\nSimulated (July, 30 d)", 
                    cex = 1.2, shrink = 1.2, ticks = F)
circular::rose.diag(loc_tam_lastdays_ltraj_df$rel.angle, bins=30, prop=2.5, units = "degrees",
                    tol = 0, main = "\nSimulated (July, 20 d, \nafter burn-in run of 10 days)",
                    cex = 1.2, shrink = 1.2, ticks = F)

```

\pagebreak

### Revisitations (coming soon)


***

\pagebreak

## Foraging in empirical data and simulated runs
```{r}
gua.plot <- gua.sf +
  geom_path(data = dat.gua.orig.jul,
            aes(x = x, y = y, group = day_month), 
            size = 0.15) +
  geom_point(data = dat.gua.orig.jul,
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior), 
             size = 2.7) +
  ggtitle("Empirical (July only, 6 days)") +
  scale_shape_manual(values = c(1, 19, 1, 1, 1, 1, 17, 1, 1)) +
  scale_color_manual(values = c("grey", "#1E8449", "grey", "magenta", "grey", "grey", "#E74C3C", "grey", "grey"))
  
gua.plot


dat.gua.orig <- dat.gua.orig %>% 
  mutate(day = lubridate::day(datetime)) %>% 
  mutate(month = lubridate::month(datetime)) %>% 
  mutate(day_month = paste0(dat.gua.orig$day, "-", dat.gua.orig$month))

gua.plot <- gua.sf +
  geom_path(data = dat.gua.orig,
            aes(x = x, y = y, group = day_month), 
            size = 0.15) +
  geom_point(data = dat.gua.orig,
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior), 
             size = 2.7) +
  ggtitle("Empirical (all data, 28 days)") +
  scale_shape_manual(values = c(1, 19, 1, 1, 1, 1, 1, 1, 1, 17, 1, 1)) +
  scale_color_manual(values = c("grey", "#1E8449", "grey", "magenta", "grey", "grey", "grey", "grey", "grey", "#E74C3C", "grey", "grey"))
  
gua.plot


gua.plot <- gua.sf +
  geom_path(data = loc_tam %>% filter(day <= 6),
            aes(x = x, y = y, group = day), 
            size = 0.15) +
  geom_point(data = loc_tam %>% filter(day <= 6),
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior)) +
  ggtitle("Simulated (first 6 days - Resources from July)") +
  scale_shape_manual(values = simulated_shapes) +
  scale_color_manual(values = simulated_colors)

gua.plot

gua.plot <- gua.sf +
  geom_path(data = loc_tam %>% filter(day > 10 & day < 17),
            aes(x = x, y = y, group = day), 
            size = 0.15) +
  geom_point(data = loc_tam %>% filter(day > 10 & day < 17),
             aes(x = x, y = y, group = behavior,
                 color = behavior,
                 shape = behavior)) +
  ggtitle("Simulated (6 days after burn in of 10 days - Resources from July)") +
  scale_shape_manual(values = simulated_shapes) +
  scale_color_manual(values = simulated_colors)
  
gua.plot

```

